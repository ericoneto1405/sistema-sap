{% extends 'base.html' %}

{% block page_title %}Novo Pedido{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">üìù Novo Pedido</h2>
        <a href="{{ url_for('pedidos.listar_pedidos') }}" class="btn btn-secondary">‚¨Ö Voltar</a>
    </div>

    <form method="POST" id="formPedido" action="{{ url_for('pedidos.novo_pedido') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group mb-3">
            <label for="cliente_id" class="form-label">Cliente</label>
            <select name="cliente_id" class="form-control" required>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <hr>

        <h5>Itens do Pedido</h5>

        <div id="itens" class="item-container"></div>

        <button type="button" class="btn btn-info btn-sm mt-2" onclick="adicionarItem();">‚ûï Adicionar Produto</button>
        
        
        <script nonce="{{ nonce }}">
            function adicionarItem() {
                console.log('üöÄ Adicionando produto...');
                
                const container = document.getElementById('itens');
                if (!container) {
                    alert('Erro: Container n√£o encontrado');
                    return;
                }
                
                // Contar itens existentes
                const itemIndex = container.children.length;
                
                // Criar HTML do produto com select simples
                const produtoHTML = `
                    <div class="d-flex gap-2 mb-2 align-items-center" data-item-index="${itemIndex}">
                        <div class="flex-grow-1">
                            <select name="produto_id" class="form-control" required>
                                <option value="">Selecione um produto...</option>
                            </select>
                        </div>
                        <div style="width: 100px;">
                            <input type="number" name="quantidade" class="form-control" placeholder="Qtd" min="1" required>
                        </div>
                        <div style="width: 150px;">
                            <input type="text" name="preco_venda" class="form-control currency-input" placeholder="Pre√ßo Venda" data-currency="true" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                    </div>
                `;
                
                // Adicionar ao container
                container.insertAdjacentHTML('beforeend', produtoHTML);
                
                console.log('‚úÖ Produto adicionado! Total:', container.children.length);
                
                // Carregar produtos via AJAX
                carregarProdutosNoSelect(container.lastElementChild.querySelector('select'));
                
                // Aplicar formata√ß√£o de moeda ao novo campo de pre√ßo
                const newPriceInput = container.lastElementChild.querySelector('input[name="preco_venda"]');
                if (newPriceInput && typeof CurrencyFormatter !== 'undefined') {
                    // Adicionar eventos de formata√ß√£o
                    newPriceInput.addEventListener('input', () => {
                        CurrencyFormatter.formatInput(newPriceInput);
                    });
                }
            }
            
            // Fun√ß√£o para carregar produtos via AJAX
            function carregarProdutosNoSelect(selectElement) {
                if (!selectElement) return;
                
                // Mostrar loading
                selectElement.innerHTML = '<option value="">Carregando produtos...</option>';
                
                // Fazer requisi√ß√£o AJAX
                fetch("{{ url_for('produtos.api_produtos') }}")
                    .then(response => response.json())
                    .then(data => {
                        // Limpar select
                        selectElement.innerHTML = '<option value="">Selecione um produto...</option>';
                        
                        // Adicionar produtos
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(produto => {
                                const option = document.createElement('option');
                                option.value = produto.id;
                                option.textContent = produto.text;
                                selectElement.appendChild(option);
                            });
                        } else {
                            selectElement.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar produtos:', error);
                        selectElement.innerHTML = '<option value="">Erro ao carregar produtos</option>';
                    });
            }
            
            // Fun√ß√£o para confirmar pedido
            window.confirmarPedido = function() {
                console.log('üîç Fun√ß√£o confirmarPedido executada!');
                try {
                    let resumo = "";
                    const cliente = document.querySelector('select[name="cliente_id"]');
                    console.log('üë§ Cliente selecionado:', cliente ? cliente.options[cliente.selectedIndex].text : 'Nenhum');
                    resumo += `<p><strong>Cliente:</strong> ${cliente.options[cliente.selectedIndex].text}</p>`;

                    const itens = document.querySelectorAll('#itens > div');
                    if (itens.length === 0) {
                        alert('Adicione ao menos um produto antes de salvar o pedido.');
                        return;
                    }

                    resumo += "<h6>Itens:</h6><ul>";
                    let formValido = true;
                    itens.forEach(item => {
                        const produtoSelect = item.querySelector('select');
                        const quantidadeInput = item.querySelector('input[type="number"]');
                        const precoVendaInput = item.querySelector('input[type="text"]');

                        if (!produtoSelect.value || !quantidadeInput.value || !precoVendaInput.value) {
                            formValido = false;
                        }

                        let produtoNome = produtoSelect.options[produtoSelect.selectedIndex]?.text || 'Produto n√£o selecionado';
                        const quantidade = quantidadeInput.value;
                        let precoFormatado = precoVendaInput.value;
                        
                        resumo += `<li>${produtoNome} - ${quantidade} un. - ${precoFormatado}</li>`;
                    });
                    resumo += "</ul>";

                    if (!formValido) {
                        alert('Preencha todos os campos de todos os itens.');
                        return;
                    }

                    document.getElementById('resumoPedido').innerHTML = resumo;
                    document.getElementById('modalConfirmacao').style.display = 'flex';
                } catch (error) {
                    console.error('Erro ao confirmar pedido:', error);
                    alert('Ocorreu um erro ao confirmar o pedido.');
                }
            }
            
            // Fun√ß√£o para fechar modal
            window.fecharModal = function() {
                document.getElementById('modalConfirmacao').style.display = 'none';
            }
            
            // Fun√ß√£o para iniciar envio do pedido
            window.iniciarEnvioPedido = function() {
                console.log('üöÄ Iniciando envio do pedido...');
                fecharModal();
                document.getElementById('modalLoading').style.display = 'flex';
                
                // Debug: verificar se o formul√°rio existe
                const form = document.getElementById('formPedido');
                console.log('üìã Formul√°rio encontrado:', form);
                console.log('üéØ Action do formul√°rio:', form.action);
                
                setTimeout(() => {
                    console.log('‚è∞ Enviando formul√°rio...');
                    form.submit();
                }, 500);
            }
            
            console.log('Fun√ß√£o adicionarItem definida inline:', typeof adicionarItem);
            console.log('Fun√ß√£o confirmarPedido definida inline:', typeof window.confirmarPedido);
        </script>
        
        
        <hr class="mt-4">

        <div class="text-end">
            <button type="button" class="btn btn-primary btn-lg" onclick="confirmarPedido()">üíæ Salvar Pedido</button>
        </div>
    </form>
</div>

<!-- Modal de Confirma√ß√£o -->
<div id="modalConfirmacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1050;">
    <div class="card" style="max-width: 500px; width: 90%;">
        <h4 class="card-header">Confirmar Pedido</h4>
        <div class="card-body">
            <div id="resumoPedido" class="mb-3"></div>
            <div class="d-flex justify-content-end gap-2">
                <button onclick="fecharModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                <button onclick="iniciarEnvioPedido()" class="btn btn-success">‚úîÔ∏è Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Carregamento -->
<div id="modalLoading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); align-items: center; justify-content: center; z-index: 2000;">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 fw-bold">SALVANDO PEDIDO</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ nonce }}">
    // Fun√ß√£o adicionarItem j√° est√° definida inline antes do bot√£o

    $(document).ready(function() {
        try {
            console.log('üöÄ DOM carregado, inicializando...');
            
            // Verificar se as fun√ß√µes est√£o dispon√≠veis
            if (typeof adicionarItem === 'function') {
                console.log('‚úÖ Fun√ß√£o adicionarItem dispon√≠vel');
            } else {
                console.error('‚ùå Fun√ß√£o adicionarItem n√£o encontrada');
            }
            
        } catch (error) {
            console.error('Erro na inicializa√ß√£o do formul√°rio:', error);
        }
    });

    // Fun√ß√µes confirmarPedido, fecharModal e iniciarEnvioPedido j√° est√£o definidas inline antes do bot√£o
</script>
{% endblock %}
