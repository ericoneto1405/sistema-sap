{% extends 'base.html' %}

{% block title %}Leitura de Notas Fiscais{% endblock %}

{% block content %}
<div class="leitura-notas-container">
    <div class="page-header">
        <h2>üßæ Leitura de DANFE</h2>
        <p>Envie o PDF ou imagem da nota fiscal eletr√¥nica para extrair os dados usando o Google Vision.</p>
    </div>

    <div class="content-grid">
        <div class="card upload-card">
            <h3>1. Upload</h3>
            <p class="text-muted">Formatos aceitos: PDF, JPG, PNG (m√°x. 10 MB).</p>
            <form method="POST" enctype="multipart/form-data" class="upload-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="arquivo">Arquivo DANFE</label>
                    <input type="file" name="arquivo" id="arquivo" accept=".pdf,.jpg,.jpeg,.png" required>
                </div>
                <button type="submit" class="btn-primary">Processar Nota</button>
            </form>
            <div class="tips">
                <strong>Dicas:</strong>
                <ul>
                    <li>Utilize o arquivo PDF original quando poss√≠vel.</li>
                    <li>Certifique-se de que a imagem esteja leg√≠vel (sem cortes ou sombras).</li>
                    <li>Para notas com v√°rias p√°ginas, envie o PDF completo.</li>
                </ul>
            </div>
        </div>

        <div class="card resultado-card">
            <h3>2. Resultado</h3>
            {% if resultado %}
                {% if resultado.ok %}
                    <div class="resumo-nota">
                        <h4>Resumo identificado</h4>
                        <dl>
                            <dt>Chave de acesso</dt>
                            <dd>{{ resultado.resumo.chave_acesso or '‚Äî' }}</dd>

                            <dt>N√∫mero da NF-e</dt>
                            <dd>{{ resultado.resumo.numero_nfe or '‚Äî' }}</dd>

                            <dt>Data de emiss√£o</dt>
                            <dd>{{ resultado.resumo.data_emissao or '‚Äî' }}</dd>

                            <dt>Valor total</dt>
                            <dd>
                                {% if resultado.resumo.valor_total %}
                                    {{ resultado.resumo.valor_total|currency_brl }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </dd>

                            <dt>CNPJs encontrados</dt>
                            <dd>
                                {% if resultado.resumo.cnpjs %}
                                    {{ resultado.resumo.cnpjs | join(', ') }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                    {% if resultado.itens %}
                    <div class="itens-nota">
                        <h4>Itens identificados</h4>
                        {% if resultado.valor_total_itens %}
                        <p class="itens-total">Soma dos itens: {{ resultado.valor_total_itens|currency_brl }}</p>
                        {% endif %}
                        <div class="table-responsive">
                            <table class="itens-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Pre√ßo Unit√°rio</th>
                                        <th>Valor Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in resultado.itens %}
                                    <tr>
                                        <td>{{ item.codigo }}</td>
                                        <td>{{ item.descricao }}</td>
                                        <td>
                                            {% if item.valor_unitario %}
                                                {{ item.valor_unitario|currency_brl }}
                                            {% else %}
                                                ‚Äî
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.valor_total %}
                                                {{ item.valor_total|currency_brl }}
                                            {% else %}
                                                ‚Äî
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    <div class="texto-bruto">
                        <h4>Texto completo reconhecido</h4>
                        <textarea readonly rows="18">{{ resultado.texto }}</textarea>
                    </div>
                {% else %}
                    <div class="alert-error">
                        {{ resultado.mensagem }}
                    </div>
                {% endif %}
            {% else %}
                <p class="text-muted">O texto reconhecido ser√° exibido aqui ap√≥s o upload.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
.leitura-notas-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
}

.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.card h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.3rem;
}

.upload-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.upload-form input[type="file"] {
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 6px;
}

.btn-primary {
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 12px 18px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-primary:hover {
    background: #5a67d8;
}

.tips ul {
    margin: 0;
    padding-left: 20px;
    color: #6c757d;
}

.resultado-card textarea {
    width: 100%;
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    background: #f8f9fa;
}

.itens-nota {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.itens-total {
    font-weight: 600;
    color: #2c3e50;
}

.table-responsive {
    overflow-x: auto;
}

.itens-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border: 1px solid #dee2e6;
}

.itens-table th,
.itens-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #f1f3f5;
}

.itens-table th {
    background: #f8f9fa;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
}

.itens-table tbody tr:nth-child(even) {
    background: #fdfdfe;
}

.resumo-nota dl {
    display: grid;
    grid-template-columns: 160px 1fr;
    gap: 8px 16px;
    margin: 0;
}

.resumo-nota dt {
    font-weight: 600;
    color: #495057;
}

.resumo-nota dd {
    margin: 0;
    color: #212529;
}

.alert-error {
    padding: 16px;
    border-radius: 8px;
    background: #fee2e2;
    color: #b91c1c;
}

@media (max-width: 768px) {
    .resumo-nota dl {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
